# v0.1 — Bootstrap

我们（人类+Agent）一起实现 Anima 的核心能力：一个能为目标项目进行自主迭代的引擎。

## TUI — 终端界面

输入 `anima` 启动终端界面，类似 Claude Code 的交互体验。

- [ ] 上方：流式输出区域，实时展示 Anima 的工作过程
  - Developer Agent 的输出
  - Acceptor Agent 的输出
  - 调度器的状态变更（当前里程碑、当前功能、验证结果、commit 等）
- [ ] 下方：输入框，仅在 Agent 暂停等待人类输入时使用（正常运行时无需干预）
- [ ] 入口命令：`anima`，在终端打开 TUI 界面

## 调度器

Anima 的核心，负责里程碑生命周期管理和 Agent 协调。一个里程碑包含多个功能，一次循环 = 一个功能。

- [ ] 启动 Developer Agent 和 Acceptor Agent（常驻进程）
- [ ] 功能迭代循环：
  - 将里程碑交给 Developer，指示每次只实现一个功能（Developer 自己读取里程碑、分析并选择当前要做的功能）
  - Developer 自行实现功能、编写测试、运行验证（ruff / pyright / pytest）
  - Developer 遇到不确定的地方：
    - 非关键 → 自主决策，继续执行
    - 关键问题不明确 → 停止循环，进入 TUI 可输入状态，等待人类澄清
  - Developer 完成后，通知 Acceptor "完成了"
  - Acceptor 自行审查：功能是否满足里程碑的验收标准（Acceptor 不跑验证，只做功能验收）
    - 不通过 → 将反馈发给 Developer，Developer 继续修改
    - 通过 → Developer 执行 git commit，进入下一轮循环（Developer 选择下一个功能）
  - Developer-Acceptor 循环超过 3 次仍未通过 → 停止循环，进入 TUI 可输入状态，等待人类介入
- [ ] 里程碑完成：Developer 判断所有功能已完成 → Acceptor 做里程碑整体验收 → 自动流转到下一个里程碑

## Agent 抽象层

定义统一的 Agent 接口，v0.1 只实现 Claude Code adapter。两个 Agent 是同一接口的两个实例，通过不同的 system prompt 赋予不同角色。

- [ ] Agent 接口定义：启动常驻进程、通过 STDIN 发送消息、通过 STDOUT 接收响应
- [ ] Claude Code adapter 实现
- [ ] Developer Agent：负责实现功能和编写测试，system prompt 要求不主动询问、自主决策
- [ ] Acceptor Agent：负责功能验收，确认功能是否实现、是否符合里程碑验收标准（不跑代码验证）
- [ ] Anima 作为通信路由：两个 Agent 通过 Anima 转发消息实现双向沟通

## 项目初始化

在目标项目目录下运行 `anima`，自动初始化工作目录。

- [ ] `.anima/` 目录结构：
  - `config.yaml` — 项目配置（需提交到 Git）
  - `milestones/` — 里程碑文件（需提交到 Git）
  - `state.yaml` — 当前迭代状态：正在执行的里程碑、任务进度等（需提交到 Git）
  - `logs/` — 迭代日志（Git 忽略）
- [ ] 自动生成 `.anima/.gitignore`，忽略 logs/

## 状态管理

- [ ] 持久化当前状态到 `.anima/state.yaml`：
  - 当前里程碑编号
  - 当前功能索引
  - 里程碑开始时的 git commit hash（用于回滚）
  - 每个功能的状态（待执行 / 已完成 / 已跳过）
  - 跳过的功能及其失败原因
- [ ] 状态在每次功能完成 / 跳过 / 里程碑切换时更新
- [ ] 启动时从 state.yaml 恢复，从上次停下的地方继续

## 里程碑流转

- [ ] 全自动流转：所有功能 Acceptor 验收通过 → 自动进入下一个里程碑
- [ ] 暂停机制：Developer 遇到关键不明确问题 / Developer-Acceptor 循环超限 → 停止循环，进入 TUI 可输入状态
- [ ] 人类输入反馈或澄清后 → 系统恢复循环继续执行

## 基础设施

- [ ] Logging：结构化日志，每次迭代记录做了什么、结果、耗时
- [ ] 质量规范：Anima 自身代码遵循 ruff + pyright strict
- [ ] 测试框架：pytest，Anima 自身代码有基础测试覆盖
- [ ] 包管理：使用 uv 管理依赖和虚拟环境
- [ ] 项目打包：pyproject.toml，可通过 `uv tool install` 安装，提供全局 `anima` 命令

## Git 策略

- [ ] 分支模型：每个里程碑一个分支（`milestone/v0.1`、`milestone/v0.2`）
  - 迭代开始时从 main 创建里程碑分支
  - 所有迭代 commit 在里程碑分支上进行
  - 验收通过 → merge 到 main，打 tag，创建 release 分支
  - 完全推倒 → 删除里程碑分支，从 main 重新拉取
- [ ] 单次迭代回滚：验证失败时 `git reset` 最近一次 commit
- [ ] Commit 规范：
  - 遵循语义化提交（Conventional Commits）：`feat:`, `fix:`, `refactor:` 等
  - Acceptor 通过后，Anima 通知 Developer 直接执行 git commit（Developer 自己生成 commit message 并提交）
